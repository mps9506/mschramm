---
title: Binomial Test for Water Quality Compliance
author: ''
date: '2018-03-26'
slug: binomial-test-for-water-quality-compliance
categories: []
tags:
  - r
  - water quality
excerpt: In the previous post, I used a geometric mean to assess water quality compliance. According to EPA guidance, this is appropriate for assessing bacteria levels in water bodies. For other conventional parameters, we can determine compliance when a standards violation is unlikely to occur more than 10% of the time.
---



<p>In the previous post, I used a geometric mean to assess water quality compliance. According to EPA guidance, this is appropriate for assessing bacteria levels in water bodies. For other conventional parameters, we can determine compliance when a standards violation is unlikely to occur more than 10% of the time. Using EPA guidance, we have both a test statistic (proportion of exceedances) and rejection region (&gt;10%). We assume that each water quality sample is a sample from the population that represents the water body with unknown probability (<span class="math inline">\(p\)</span>) of exceeding the criterion. Therefore, the null hyposthesis:</p>
<p><span class="math display">\[H_0 : \pi \le p_0\]</span> where <span class="math inline">\(p_0\)</span> is the acceptable exceedance rate and equals 0.1. By transforming measurements below the criterion to 0 (failure), and measurements above the criterion as 1 (success) we can apply a simple binomial test to samples collected during the assessment period to evaluate current compliance. This binomial approach is discussed in detail by <a href="https://pubs.acs.org/doi/abs/10.1021/es001159e">Smith et. al 2001</a>.</p>
<p>In the example below, I am importing grab dissolved oxygen at two stations on water body. Some events utilize two or more samples at varying depths, those samples are averaged to determine the event dissolved oxygen value.</p>
<pre class="r"><code>library(readr)
library(dplyr)
library(ggplot2)

file &lt;- url(&quot;https://gist.githubusercontent.com/mps9506/274e0debee7e7f1289dac3371ce05d1e/raw/284ff43565d03bd57c59c3151feaa739abd40f2e/1501_DO.txt&quot;)
df &lt;- read_delim(file, &quot;|&quot;)

df &lt;- df %&gt;%
  #select(`RFA(Sample Set ID)/Tag_id`, Segment, `Parameter Code`, Value, `End Date`, `Monitoring Type`) %&gt;%
  mutate(`End Date` = as.Date(`End Date`, &quot;%m/%d/%Y&quot;)) %&gt;%
  filter(`Monitoring Type` == &quot;RT&quot;) %&gt;%
  arrange(`End Date`) %&gt;%
  group_by(`End Date`, `Station ID`) %&gt;%
  summarise(Value = mean(Value))

ggplot(df) +
  geom_point(aes(x = `End Date`, y = Value)) +
  geom_hline(aes(yintercept = 4)) +
  xlab(&quot;Sample Date&quot;) + ylab(&quot;DO (mg/L)&quot;)</code></pre>
<p><img src="/post/2018-03-26-binomial-test-for-water-quality-compliance_files/figure-html/unnamed-chunk-1-1.png" width="672" /></p>
<p>In order to determine if the waterbody meets the water quality criterion I select the water quality values during the assessment period and use the <code>binom.test</code> function in R. The arguments for <code>binom.test</code> are</p>
<pre class="eval"><code>binom.test(x, n, p = 0.5,
           alternative = c(&quot;two.sided&quot;, &quot;less&quot;, &quot;greater&quot;),
           conf.level = 0.95)

x    number of successes, or a vector of length 2 giving the numbers of successes and failures, respectively.
n    number of trials; ignored if x has length 2.
p    hypothesized probability of success.
alternative    indicates the alternative hypothesis and must be one of &quot;two.sided&quot;, &quot;greater&quot; or &quot;less&quot;. You can specify just the initial letter.
conf.level    confidence level for the returned confidence interval.
</code></pre>
<p>So we need to first count the total number of “successes,” which in this case means water quality exceedances (DO value less than 4 mg/L). Note, that this is slightly different than worded above since we typically think of exceedance as above a water quality standard. We also need to count the total number of trials. Both of these are accomplished using dplyr and the <code>mutate</code>, <code>case_when</code>, and <code>summarise</code> functions.</p>
<pre class="r"><code>binomial_df &lt;- df %&gt;%
  filter(`End Date` &gt; as.Date(&quot;2005-11-30&quot;) &amp; `End Date` &lt; as.Date(&quot;2012-12-01&quot;)) %&gt;%
  ungroup() %&gt;%
  mutate(
    success = case_when(
      Value &lt; 4 ~ 1,
      Value &gt;= 4 ~ 0
      ))

binomial_df &lt;- binomial_df %&gt;%
  summarise(n = n(), x = sum(success))
binomial_df</code></pre>
<pre><code>## # A tibble: 1 x 2
##       n     x
##   &lt;int&gt; &lt;dbl&gt;
## 1    67  15.0</code></pre>
<p>So, now we have 15 exceedances for 67 trials. This matches the values indicated on the <a href="https://www.tceq.texas.gov/assets/public/waterquality/swqm/assess/14txir/2014_basin15.pdf">TCEQ waterbody assessment report</a>. (Another pdf warning!)</p>
<p>The hypothesised rate of success is given to us by the water quality standard, 10%. Therefore the null and alternative hypothesis are: <span class="math display">\[H_0 : \pi \le 0.10\]</span> <span class="math display">\[H_1 : \pi \gt 0.10\]</span></p>
<pre class="r"><code>binom.test(x = binomial_df$x, n = binomial_df$n, p = 0.1, alternative = &quot;g&quot;)</code></pre>
<pre><code>## 
##  Exact binomial test
## 
## data:  binomial_df$x and binomial_df$n
## number of successes = 15, number of trials = 67, p-value =
## 0.002213
## alternative hypothesis: true probability of success is greater than 0.1
## 95 percent confidence interval:
##  0.1433629 1.0000000
## sample estimates:
## probability of success 
##              0.2238806</code></pre>
<p>Under this scenario, we accept reject the null hypothesis. The water body is listed as impaired for depressed dissolved oxygen according to water quality standards.</p>
<p>We can simplify this test by creating a table or graph depicting the number of exceedances required for a listing based on the number of samples collected. In fact, this table is provided in the TCEQ assessment guide. Using <code>qbinom</code> we can create a table listing the number of exceedances leading to an impairment listing:<label for="tufte-mn-" class="margin-toggle">⊕</label><input type="checkbox" id="tufte-mn-" class="margin-toggle"><span class="marginnote">The maximum Type 1 error rate specified in the State of Texas’s assessment guidance is currently 20% for impairment listings.</span></p>
<pre class="r"><code>binom_chart &lt;- data_frame(n = 10:100,
                       exceedances = qbinom(1-0.20, size = 10:100, prob = 0.1) + 1)
binom_chart</code></pre>
<pre><code>## # A tibble: 91 x 2
##        n exceedances
##    &lt;int&gt;       &lt;dbl&gt;
##  1    10        3.00
##  2    11        3.00
##  3    12        3.00
##  4    13        3.00
##  5    14        3.00
##  6    15        3.00
##  7    16        4.00
##  8    17        4.00
##  9    18        4.00
## 10    19        4.00
## # ... with 81 more rows</code></pre>
<p><img src="/post/2018-03-26-binomial-test-for-water-quality-compliance_files/figure-html/unnamed-chunk-5-1.png" width="672" /></p>
<p>I am also interested in visualizing the trends in exceedance probability. Using the same date-based rolling functions in the previous post, I will apply the binomal test to 7-yrs of the most recent data and plot the probability over sampling date.</p>
<pre class="r"><code>library(purrr)
library(lubridate) ## import lubridate for as.duration and dyears functions

## This function will be applied to each sample,
## return the estimated probability from the previous 7-yrs of data

myfunc &lt;- function(dates, values, years, i){
  temp &lt;- values[as.duration(dates[i] - dates)/dyears(1) &lt;= years &amp; as.duration(dates[i] - dates)/dyears(1) &gt;= 0]
  df &lt;- data_frame(temp) %&gt;%
    summarise(n = n(), successes = as.integer(sum(temp)))
  
  results &lt;- binom.test(x = df$successes, n = df$n, p = 0.1, alternative = &quot;g&quot;)
  
  return(results$estimate)
}

df2 &lt;- df %&gt;%
  ungroup() %&gt;%
  arrange(`End Date`) %&gt;%
  mutate(Success = as.integer(case_when(
    Value &lt; 4 ~ 1,
    Value &gt;= 4 ~ 0
    )))

df2 &lt;- df2 %&gt;%
  mutate(ep = map_dbl(seq_along(.$`End Date`),
                  ~myfunc(dates = `End Date`, values = Success, years = 7, i = .x)))

df2</code></pre>
<pre><code>## # A tibble: 142 x 5
##    `End Date` `Station ID` Value Success    ep
##    &lt;date&gt;            &lt;int&gt; &lt;dbl&gt;   &lt;int&gt; &lt;dbl&gt;
##  1 2000-01-03        12515  6.19       0     0
##  2 2000-03-14        12515  6.70       0     0
##  3 2000-03-16        12515  6.41       0     0
##  4 2000-05-03        12515  4.42       0     0
##  5 2000-06-15        12515  4.86       0     0
##  6 2000-07-11        12515  4.48       0     0
##  7 2000-09-12        12515  5.64       0     0
##  8 2000-10-18        12515  8.82       0     0
##  9 2000-11-06        12515  5.96       0     0
## 10 2000-12-20        12515 12.5        0     0
## # ... with 132 more rows</code></pre>
<p>A little ggplot to create the figure:</p>
<pre class="r"><code>ggplot(df2) +
  geom_step(aes(x = `End Date`, y = ep, color = &quot;7-yr estimated probability of exceedance&quot;)) +
  geom_hline(aes(yintercept = 0.1, color = &quot;Allowable proportion of exceedances&quot;), size = .75) +
  theme_ipsum_rc() +
  scale_color_brewer(name = &quot;&quot;, type = &quot;qual&quot;, palette = &quot;Set2&quot;) +
  labs(
    title = &quot;Estimated probability of exceeding water quality standard&quot;,
    subtitle = &quot;Based on dissolved oxygen samples in Tres Palacios Tidal&quot;,
    caption = &quot;Source: TCEQ CRP Data Tool&quot;,
    x = &quot;Sample date&quot;, y = &quot;Estimated probability&quot;
    )</code></pre>
<p><img src="/post/2018-03-26-binomial-test-for-water-quality-compliance_files/figure-html/unnamed-chunk-7-1.png" width="672" /></p>
