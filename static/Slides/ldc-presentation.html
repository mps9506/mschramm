<!DOCTYPE html>
<html>
  <head>
    <title>FDC and LDC Development in R</title>
    <meta charset="utf-8">
    <meta name="author" content="Michael Schramm" />
    <link href="libs/remark-css/default.css" rel="stylesheet" />
    <link rel="stylesheet" href="fonts.css" type="text/css" />
    <link rel="stylesheet" href="twri.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

# FDC and LDC Development in R
### Michael Schramm

---




# Basic steps

--

- Obtain mean daily flows sorted by date for entire period of interest. If exceedances are primarily under high flow conditions, instanteous flows may provide a more accurate flow and load estimation[1].

--

- Plot exceedance probability (x-axis) against flow (y-axis) `\(=\)` flow duration curve

--

- Convert flow to load `\(flow\times time\times concentration\)`

--

- Convert measured concentration to load and overlay on the load duration curve

---

# Flow

- Obtain flow data at relevant USGS gage

--

- Do this in R with the `dataRetrieval` package

--


```r
library(dataRetrieval)

# download data to R as a dataframe 
# this returns flow as mean daily flow in cubic feet per second
flow &lt;- readNWISdv("08186000", "00060", "2001-01-01", "2016-12-31")

# columns do not have informational column names
# this function will automatically rename them
flow &lt;- renameNWISColumns(flow)
```

--


```
##   agency_cd  site_no       Date Flow Flow_cd
## 1      USGS 08186000 2001-01-01   61       A
## 2      USGS 08186000 2001-01-02   56       A
## 3      USGS 08186000 2001-01-03   53       A
## 4      USGS 08186000 2001-01-04   51       A
## 5      USGS 08186000 2001-01-05   49       A
## 6      USGS 08186000 2001-01-06   48       A
```

---

# Calculate flow exceedance
Use `dplyr` package and some built in R functions to make a flow exceedance column


```r
library(dplyr)
flow &lt;- flow %&gt;%
  arrange(Flow) %&gt;% # gets our flows into order by value of flow
  mutate(Exceedance = percent_rank(-Flow)) # exceedance = 1 - cumulative distribution function of flow
```
--

```
##   agency_cd  site_no       Date Flow Flow_cd Exceedance
## 1      USGS 08186000 2015-04-08    0       A   0.997604
## 2      USGS 08186000 2015-04-09    0       A   0.997604
## 3      USGS 08186000 2015-04-10    0       A   0.997604
## 4      USGS 08186000 2015-04-21    0       A   0.997604
## 5      USGS 08186000 2015-05-01    0       A   0.997604
## 6      USGS 08186000 2015-05-05    0       A   0.997604
```

---

# Plot
Use `ggplot2` to make a flow duration curve

```r
library(ggplot2)
fdc &lt;- ggplot(flow, aes(x = Exceedance, y = Flow)) +
  geom_line() +
  scale_y_log10(labels = scales::comma) +
  scale_x_continuous(labels = scales::percent) +
  labs(x = "Percent of Days Flow Exceeded",
       y = "Flow (cfs)")
```

---

#Flow Duration Curve

```
## Warning: Transformation introduced infinite values in continuous y-axis
```

&lt;img src="ldc-presentation_files/figure-html/unnamed-chunk-6-1.png" style="display: block; margin: auto;" /&gt;

---
FDC in a handful of lines

```r
library(dataRetrieval)
library(dplyr)
library(ggplot2)

flow &lt;- readNWISdv("08186000", "00060", "2001-01-01", "2016-12-31")
flow &lt;- renameNWISColumns(flow)

flow &lt;- flow %&gt;%
  arrange(Flow) %&gt;% 
  mutate(Exceedance = percent_rank(-Flow))

ggplot(flow, aes(x = Exceedance, y = Flow)) +
  geom_line() +
  scale_y_log10(labels = scales::comma) +
  scale_x_continuous(labels = scales::percent) +
  labs(x = "Percent of Days Flow Exceeded",
       y = "Flow (cfs)")
```

---
# Convert FDC to LDC

`\(Daily Load=126colonies/100mL\times 28316.8mL/foot^3\times feet^3/second\times 86,400 seconds/day\)`

Use `dplyr` to create new column with load duration curve values calculated from mean daily flow and the 126 cfu/100 mL standard. 


```r
flow &lt;- flow %&gt;%
  mutate(ldc = 126/100 * 28316.8 * Flow * 86400)
```
--

```
##   agency_cd  site_no       Date Flow Flow_cd Exceedance ldc
## 1      USGS 08186000 2015-04-08    0       A   0.997604   0
## 2      USGS 08186000 2015-04-09    0       A   0.997604   0
## 3      USGS 08186000 2015-04-10    0       A   0.997604   0
## 4      USGS 08186000 2015-04-21    0       A   0.997604   0
## 5      USGS 08186000 2015-05-01    0       A   0.997604   0
## 6      USGS 08186000 2015-05-05    0       A   0.997604   0
```

---
#Load Duration Curve
Use `ggplot2` again

```r
ggplot(flow, aes(x = Exceedance, y = ldc)) +
  geom_line() +
  scale_y_log10() +
  scale_x_continuous(labels = scales::percent) +
  labs(x = "Percent of Days Load Exceeded",
       y = "Load (colonies per day)")
```

```
## Warning: Transformation introduced infinite values in continuous y-axis
```

&lt;img src="ldc-presentation_files/figure-html/unnamed-chunk-10-1.png" style="display: block; margin: auto;" /&gt;


---
We also need to add measured concentrations, converted to loads.
Go back to our dataframe, we can import water quality measurements and join them by date.

We are going to use the `dataRetrieval` package to download monitoring data from STORET.

--

Alternatively, use the `readr` package and `read_csv()` or `read_xl()` functions to import concentration data. Your data should have one column for sample date and one column for concentration. 

--

Using `dataRetrieval`:

```r
ecoli &lt;- readWQPqw(siteNumbers = c("TCEQMAIN-14211"), parameterCd = "Escherichia coli")
## When I inspect this data, it includes the holding time, I just want concentrations.
## so the next lines will filter rows that report holding time in hours
## and select only the relevant variable columns and rename them
ecoli &lt;- ecoli %&gt;%
  filter(ResultMeasure.MeasureUnitCode != "hours") %&gt;%
  select(Date = ActivityStartDate, Concentration = ResultMeasureValue)
```
--

```
## # A tibble: 6 x 2
##   Date       Concentration
##   &lt;date&gt;             &lt;dbl&gt;
## 1 2011-06-29            88
## 2 2011-12-21           140
## 3 2011-11-30            69
## 4 2011-12-07            69
## 5 2011-11-02            93
## 6 2011-10-12           500
```

---
We can join the `ecoli` dataframe to the `flow` dataframe using the date and ActivityStartDate column and the `left_join()` function in `dplyr`.

```r
df &lt;- flow %&gt;%
  left_join(ecoli, by = "Date")
```
--

```r
head(df)
```

```
##   agency_cd  site_no       Date Flow Flow_cd Exceedance ldc Concentration
## 1      USGS 08186000 2015-04-08    0       A   0.997604   0           280
## 2      USGS 08186000 2015-04-09    0       A   0.997604   0            NA
## 3      USGS 08186000 2015-04-10    0       A   0.997604   0            NA
## 4      USGS 08186000 2015-04-21    0       A   0.997604   0            NA
## 5      USGS 08186000 2015-05-01    0       A   0.997604   0            NA
## 6      USGS 08186000 2015-05-05    0       A   0.997604   0            NA
```

---
Estimate daily loads from measured concentrations
`\(Colonies/100mL\times Flow\times 28316.8mL/foot^3\times 86,400 seconds/day\)`


```r
df &lt;- df %&gt;%
  mutate(load = Concentration/100 * Flow * 28316.8 * 86400)
```
--

```
##   agency_cd  site_no       Date Flow Flow_cd Exceedance ldc Concentration
## 1      USGS 08186000 2015-04-08    0       A   0.997604   0           280
## 2      USGS 08186000 2015-04-09    0       A   0.997604   0            NA
## 3      USGS 08186000 2015-04-10    0       A   0.997604   0            NA
## 4      USGS 08186000 2015-04-21    0       A   0.997604   0            NA
## 5      USGS 08186000 2015-05-01    0       A   0.997604   0            NA
## 6      USGS 08186000 2015-05-05    0       A   0.997604   0            NA
##   load
## 1    0
## 2   NA
## 3   NA
## 4   NA
## 5   NA
## 6   NA
```

---
# Plot the LDC


```r
ggplot(df) +
  geom_line(aes(x = Exceedance, y = ldc)) +
  geom_point(aes(x = Exceedance, y = load), alpha = 0.4) +
  scale_y_log10() + scale_x_continuous(labels = scales::percent) +
  labs(x = "Percent of Days Load Exceeded",
       y = "Load (colonies per day)")
```

&lt;img src="ldc-presentation_files/figure-html/unnamed-chunk-17-1.png" style="display: block; margin: auto;" /&gt;


---

We can break our LDC into a few flow categories here. This is subjective, but it appears five categories would be appropriate.  provides some guidance.


```r
ggplot(df) +
  geom_line(aes(x = Exceedance, y = ldc)) +
  geom_point(aes(x = Exceedance, y = load), alpha = 0.4) +
  scale_y_log10() + scale_x_continuous(labels = scales::percent) +
  labs(x = "Percent of Days Load Exceeded",
       y = "Load (colonies per day)") +
* geom_vline(xintercept = c(.10,.4,.6,.90), linetype = 2)
```

&lt;img src="ldc-presentation_files/figure-html/unnamed-chunk-18-1.png" style="display: block; margin: auto;" /&gt;

---

There are a few approaches for estimating loads. For example, we could use the USGS `LOADEST` tool estimate loads with regressions. For simplicilty, I will estimate the geometric mean load in each flow category from measured values and subtract that from the geometric mean allowable load. This is used in the Tres Palacios, Carancahua Bay, and Aransas/Poesta Creek TMDLs.

---

The general approach:

--

- Group estimated loads and allowable loads by flow category

--

- Calculate the geomean for each flow category

--

- Take the difference to estimate mean daily reductions for each category

---
Unfortunately R does not have a built-in geomean function, so let's create one. (Consider this your introduction to functional programming. The following line block creates a function you can use later, just like `mean()` or `sum()`)

```r
gm_mean &lt;- function(x, na.rm=TRUE){
  if (na.rm == TRUE) {
    x &lt;- x[!is.na(x)]
    exp(sum(log(x[x &gt; 0]), na.rm = na.rm) / length(x))
  }
  else {
    exp(sum(log(x[x &gt; 0]), na.rm = na.rm) / length(x))
  }
}
```

---
Now create groups for measured and allowable loads. We decided on 0-10%, 10-40%, 40-60%, 60-90%, and 90-100% earlier.

```r
# creates a column specifying the flow category based on exceedance value
df &lt;- df %&gt;%
  mutate(fc = case_when(
    Exceedance &lt;= .10 ~ "Highest Flows",
    Exceedance &gt; .10 &amp; Exceedance &lt;= .40 ~ "Moist Conditions",
    Exceedance &gt; .40 &amp; Exceedance &lt;= .60 ~ "Mid-range Conditions",
    Exceedance &gt; .60 &amp; Exceedance &lt;= .90 ~ "Dry Conditions",
    Exceedance &gt; .90 &amp; Exceedance &lt;= 1 ~ "Low Flows"
  ))

df_summary &lt;- df %&gt;%
  group_by(fc) %&gt;%
  summarise(AllowableLoad = gm_mean(ldc),
            GMConc = gm_mean(Concentration),
            MeasuredLoad = gm_mean(load),
            Exceedance = round(median(Exceedance),digits = 2))
```

--


```
## # A tibble: 5 x 5
##   fc                   AllowableLoad GMConc MeasuredLoad Exceedance
##   &lt;chr&gt;                        &lt;dbl&gt;  &lt;dbl&gt;        &lt;dbl&gt;      &lt;dbl&gt;
## 1 Dry Conditions             8.67e10   120.      8.02e10       0.75
## 2 Highest Flows              2.12e12  2058.      2.37e13       0.05
## 3 Low Flows                  2.15e10   146.      1.78e10       0.95
## 4 Mid-range Conditions       1.51e11   181.      2.10e11       0.5 
## 5 Moist Conditions           3.03e11   473.      1.16e12       0.25
```

---
#Basic LDC

```r
ggplot(df) +
  geom_line(aes(x = Exceedance, y = ldc)) +
  geom_point(aes(x = Exceedance, y = load), alpha = 0.4) +
  geom_point(data = df_summary, aes(x = Exceedance, y = MeasuredLoad), shape = 7, color = "red") +
  scale_y_log10() + scale_x_continuous(labels = scales::percent) +
  labs(x = "Percent of Days Load Exceeded",
       y = "Load (colonies per day)") +
  geom_vline(xintercept = c(.10,.4,.6,.90), linetype = 2)
```

&lt;img src="ldc-presentation_files/figure-html/unnamed-chunk-22-1.png" style="display: block; margin: auto;" /&gt;

---
We probably want to fancy this plot up.


```r
ggplot(df) +
  geom_line(aes(x = Exceedance, y = ldc)) +
  geom_point(aes(x = Exceedance, y = load), alpha = 0.4) +
  geom_point(data = df_summary, aes(x = Exceedance, y = MeasuredLoad), shape = 7, color = "red") +
  scale_y_log10() + scale_x_continuous(labels = scales::percent) +
  labs(x = "Percent of Days Load Exceeded",
       y = "Load (colonies per day)") +
  geom_vline(xintercept = c(.10,.4,.6,.90), linetype = 2)
```

&lt;img src="ldc-presentation_files/figure-html/unnamed-chunk-23-1.png" style="display: block; margin: auto;" /&gt;


---
## Refs
[1] M. Morrison and J. Bonta. _Development of Duration-Curve Based
Methods for Quantifying Variability and Change in Watershed
Hydrology and Water Quality Hydrology and Water Quality_. Tech.
rep. May. EPA, 2008.
    </textarea>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "github",
"highlightLines": true,
"countIncrementalSlides": false,
"ratio": "16:9"
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function() {
  var d = document, s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})();</script>

<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  tex2jax: {
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre']
  }
});
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
