<!DOCTYPE html>
<html>
  <head>
    <title>FDC and LDC Development in R</title>
    <meta charset="utf-8">
    <meta name="author" content="Michael Schramm" />
    <link href="libs/remark-css/default.css" rel="stylesheet" />
    <link rel="stylesheet" href="fonts.css" type="text/css" />
    <link rel="stylesheet" href="twri.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

# FDC and LDC Development in R
### Michael Schramm

---




# Basic steps

--

- Obtain mean daily flows sorted by date for entire period of interest. If exceedances are primarily under high flow conditions, instanteous flows may provide a more accurate flow and load estimation[1].

--

- Plot exceedance probability (x-axis) against flow (y-axis) `\(=\)` flow duration curve

--

- Convert flow to load `\(flow\times time\times concentration\)`

--

- Convert measured concentration to load and overlay on the load duration curve

---

# Flow

- Obtain flow data at relevant USGS gage

--

- Do this in R with the `dataRetrieval` package

--


```r
library(dataRetrieval)

# download data to R as a dataframe 
# this returns flow as mean daily flow in cubic feet per second
flow &lt;- readNWISdv(siteNumbers = "08186000", 
                   parameterCd = "00060", 
                   startDate = "2001-01-01", 
                   endDate = "2016-12-31",
                   statCd = "00003")

# columns do not have informational column names
# this function will automatically rename them
flow &lt;- renameNWISColumns(flow)
```

--


```
##   agency_cd  site_no       Date Flow Flow_cd
## 1      USGS 08186000 2001-01-01   61       A
## 2      USGS 08186000 2001-01-02   56       A
## 3      USGS 08186000 2001-01-03   53       A
## 4      USGS 08186000 2001-01-04   51       A
## 5      USGS 08186000 2001-01-05   49       A
## 6      USGS 08186000 2001-01-06   48       A
```

---

# Calculate flow exceedance
Use `dplyr` package and some built in R functions to make a flow exceedance column


```r
library(dplyr)
flow &lt;- flow %&gt;%
  arrange(Flow) %&gt;% # gets our flows into order by value of flow
  mutate(Exceedance = percent_rank(-Flow)) %&gt;% # exceedance = 1 - cumulative distribution function of flow
  filter(Flow &gt; 0)
```
--

```
##   agency_cd  site_no       Date Flow Flow_cd Exceedance
## 1      USGS 08186000 2015-05-21 0.05       A  0.9974328
## 2      USGS 08186000 2015-04-07 0.09       A  0.9972617
## 3      USGS 08186000 2015-04-06 1.52       A  0.9970905
## 4      USGS 08186000 2015-04-12 3.21       A  0.9969194
## 5      USGS 08186000 2015-04-30 3.89       A  0.9967482
## 6      USGS 08186000 2015-04-05 4.66       A  0.9965771
```

---

# Plot
Use `ggplot2` to make a flow duration curve

```r
library(ggplot2)
fdc &lt;- ggplot(flow, aes(x = Exceedance, y = Flow)) +
  geom_line() +
  scale_y_log10(labels = scales::comma) +
  scale_x_continuous(labels = scales::percent) +
  labs(x = "Percent of Days Flow Exceeded",
       y = "Flow (cfs)")
```

---

#Flow Duration Curve
&lt;img src="ldc-presentation_files/figure-html/unnamed-chunk-6-1.png" style="display: block; margin: auto;" /&gt;

---
FDC in a handful of lines

```r
library(dataRetrieval)
library(dplyr)
library(ggplot2)

flow &lt;- readNWISdv("08186000", "00060", "2001-01-01", "2016-12-31")
flow &lt;- renameNWISColumns(flow)

flow &lt;- flow %&gt;%
  arrange(Flow) %&gt;% 
  mutate(Exceedance = percent_rank(-Flow)) %&gt;%
  filter(Flow &gt; 0)

ggplot(flow, aes(x = Exceedance, y = Flow)) +
  geom_line() +
  scale_y_log10(labels = scales::comma) +
  scale_x_continuous(labels = scales::percent) +
  labs(x = "Percent of Days Flow Exceeded",
       y = "Flow (cfs)")
```

---
# Convert FDC to LDC

`\(Daily Load=126colonies/100mL\times 28316.8mL/foot^3\times feet^3/second\times 86,400 seconds/day\)`

Use `dplyr` to create new column with load duration curve values calculated from mean daily flow and the 126 cfu/100 mL standard. 


```r
flow &lt;- flow %&gt;%
  mutate(ldc = 126/100 * 28316.8 * Flow * 86400)
```
--

```
##   agency_cd  site_no       Date Flow Flow_cd Exceedance         ldc
## 1      USGS 08186000 2015-05-21 0.05       A  0.9974328   154134006
## 2      USGS 08186000 2015-04-07 0.09       A  0.9972617   277441210
## 3      USGS 08186000 2015-04-06 1.52       A  0.9970905  4685673775
## 4      USGS 08186000 2015-04-12 3.21       A  0.9969194  9895403170
## 5      USGS 08186000 2015-04-30 3.89       A  0.9967482 11991625648
## 6      USGS 08186000 2015-04-05 4.66       A  0.9965771 14365289337
```

---
#Load Duration Curve
Use `ggplot2` again

```r
ggplot(flow, aes(x = Exceedance, y = ldc)) +
  geom_line() +
  scale_y_log10() +
  scale_x_continuous(labels = scales::percent) +
  labs(x = "Percent of Days Load Exceeded",
       y = "Load (colonies per day)")
```

&lt;img src="ldc-presentation_files/figure-html/unnamed-chunk-10-1.png" style="display: block; margin: auto;" /&gt;


---
We also need to add measured concentrations, converted to loads.
Go back to our dataframe, we can import water quality measurements and join them by date.

We are going to use the `dataRetrieval` package to download monitoring data from STORET.

--

Alternatively, use the `readr` package and `read_csv()` or `read_xl()` functions to import concentration data. Your data should have one column for date and one column for concentration. 

--

Using `dataRetrieval`:

```r
ecoli &lt;- readWQPqw(siteNumbers = c("TCEQMAIN-14211"), parameterCd = "Escherichia coli")
## When I inspect this data, it includes the holding time, I just want concentrations.
## so the next lines will filter rows that report holding time in hours
## and select only the relevant variable columns and rename them
ecoli &lt;- ecoli %&gt;%
  filter(ResultMeasure.MeasureUnitCode != "hours") %&gt;%
  select(Date = ActivityStartDate, Concentration = ResultMeasureValue)
```
--

```
## # A tibble: 6 x 2
##   Date       Concentration
##   &lt;date&gt;             &lt;dbl&gt;
## 1 2011-12-21           140
## 2 2011-09-14           330
## 3 2011-06-21          1100
## 4 2011-09-28           120
## 5 2011-06-08           150
## 6 2011-12-14            84
```

---
We can join the `ecoli` dataframe to the `flow` dataframe using the date and ActivityStartDate column and the `left_join()` function in `dplyr`.

```r
df &lt;- flow %&gt;%
  left_join(ecoli, by = "Date")
```
--

```r
head(df)
```

```
##   agency_cd  site_no       Date Flow Flow_cd Exceedance         ldc
## 1      USGS 08186000 2015-05-21 0.05       A  0.9974328   154134006
## 2      USGS 08186000 2015-04-07 0.09       A  0.9972617   277441210
## 3      USGS 08186000 2015-04-06 1.52       A  0.9970905  4685673775
## 4      USGS 08186000 2015-04-12 3.21       A  0.9969194  9895403170
## 5      USGS 08186000 2015-04-30 3.89       A  0.9967482 11991625648
## 6      USGS 08186000 2015-04-05 4.66       A  0.9965771 14365289337
##   Concentration
## 1            NA
## 2            NA
## 3            NA
## 4            NA
## 5            NA
## 6            NA
```

---
Estimate daily loads from measured concentrations
`\(Colonies/100mL\times Flow\times 28316.8mL/foot^3\times 86,400 seconds/day\)`


```r
df &lt;- df %&gt;%
  mutate(load = Concentration/100 * Flow * 28316.8 * 86400)
```
--

```
##   agency_cd  site_no       Date Flow Flow_cd Exceedance         ldc
## 1      USGS 08186000 2015-05-21 0.05       A  0.9974328   154134006
## 2      USGS 08186000 2015-04-07 0.09       A  0.9972617   277441210
## 3      USGS 08186000 2015-04-06 1.52       A  0.9970905  4685673775
## 4      USGS 08186000 2015-04-12 3.21       A  0.9969194  9895403170
## 5      USGS 08186000 2015-04-30 3.89       A  0.9967482 11991625648
## 6      USGS 08186000 2015-04-05 4.66       A  0.9965771 14365289337
##   Concentration load
## 1            NA   NA
## 2            NA   NA
## 3            NA   NA
## 4            NA   NA
## 5            NA   NA
## 6            NA   NA
```

---
# Plot the LDC


```r
ggplot(df) +
  geom_line(aes(x = Exceedance, y = ldc)) +
  geom_point(aes(x = Exceedance, y = load), alpha = 0.4) +
  scale_y_log10() + scale_x_continuous(labels = scales::percent) +
  labs(x = "Percent of Days Load Exceeded",
       y = "Load (colonies per day)")
```

&lt;img src="ldc-presentation_files/figure-html/unnamed-chunk-17-1.png" style="display: block; margin: auto;" /&gt;


---

We can break our LDC into a few flow categories here. This is subjective, but it appears five categories would be appropriate.  provides some guidance.


```r
ggplot(df) +
  geom_line(aes(x = Exceedance, y = ldc)) +
  geom_point(aes(x = Exceedance, y = load), alpha = 0.4) +
  scale_y_log10() + scale_x_continuous(labels = scales::percent) +
  labs(x = "Percent of Days Load Exceeded",
       y = "Load (colonies per day)") +
* geom_vline(xintercept = c(.10,.4,.6,.90), linetype = 2)
```

&lt;img src="ldc-presentation_files/figure-html/unnamed-chunk-18-1.png" style="display: block; margin: auto;" /&gt;

---

There are a few approaches for estimating loads. For example, we could use the USGS `LOADEST` tool estimate loads with regressions. For simplicilty, I will estimate the geometric mean load in each flow category from measured values and subtract that from the geometric mean allowable load. This is used in the Tres Palacios, Carancahua Bay, and Aransas/Poesta Creek TMDLs.

---

The general approach:

--

- Group estimated loads and allowable loads by flow category

--

- Calculate the geomean for each flow category

--

- Take the difference to estimate mean daily reductions for each category

---
We need to load another package to get a function that calculates the geometric mean.

```r
## Comment out the line below to install the package if you don't have it
## install.packages("DescTools")
library(DescTools)
```

---
Now create a column for the flow groups. We decided on 0-10%, 10-40%, 40-60%, 60-90%, and 90-100% earlier.

```r
# creates a column specifying the flow category based on exceedance value
df &lt;- df %&gt;%
  mutate(fc = case_when(
    Exceedance &lt;= .10 ~ "Highest Flows",
    Exceedance &gt; .10 &amp; Exceedance &lt;= .40 ~ "Moist Conditions",
    Exceedance &gt; .40 &amp; Exceedance &lt;= .60 ~ "Mid-range Conditions",
    Exceedance &gt; .60 &amp; Exceedance &lt;= .90 ~ "Dry Conditions",
    Exceedance &gt; .90 &amp; Exceedance &lt;= 1 ~ "Low Flows"
  ))
```

---
Now we can use dplyr to group the observations by flow category (the new fc column) and calculate the geometric mean in each category

```r
df_summary &lt;- df %&gt;%
  group_by(fc) %&gt;%
  summarise(AllowableLoad = Gmean(ldc, na.rm = TRUE),  ## Gmean function is from DescTools
            GMConc = Gmean(Concentration, na.rm = TRUE),
            MeasuredLoad = Gmean(load, na.rm = TRUE),
            Exceedance = round(median(Exceedance),digits = 2)) ## Exceedance is the x-axis coordinate
```


--


```
## # A tibble: 5 x 5
##   fc                   AllowableLoad GMConc MeasuredLoad Exceedance
##   &lt;chr&gt;                        &lt;dbl&gt;  &lt;dbl&gt;        &lt;dbl&gt;      &lt;dbl&gt;
## 1 Dry Conditions             8.67e10   120.      8.02e10       0.75
## 2 Highest Flows              2.12e12  2058.      2.37e13       0.05
## 3 Low Flows                  4.03e10   142.      4.58e10       0.95
## 4 Mid-range Conditions       1.51e11   181.      2.10e11       0.5 
## 5 Moist Conditions           3.03e11   473.      1.16e12       0.25
```

---
#Basic LDC

```r
ggplot(df) +
  geom_line(aes(x = Exceedance, y = ldc)) +
  geom_point(aes(x = Exceedance, y = load), alpha = 0.4) +
  geom_point(data = df_summary, aes(x = Exceedance, y = MeasuredLoad), shape = 7, color = "red") +
  scale_y_log10() + scale_x_continuous(labels = scales::percent) +
  labs(x = "Percent of Days Load Exceeded",
       y = "Load (colonies per day)") +
  geom_vline(xintercept = c(.10,.4,.6,.90), linetype = 2)
```

&lt;img src="ldc-presentation_files/figure-html/unnamed-chunk-23-1.png" style="display: block; margin: auto;" /&gt;

---
We probably want to fancy this plot up.


```r
p &lt;- ggplot(df) +
  geom_line(aes(x = Exceedance, y = ldc)) + ## plots the allowable load
  geom_point(aes(x = Exceedance, y = load), 
             alpha = 0.4) + ## plots the measured loads
  geom_point(data = df_summary, aes(x = Exceedance, y = MeasuredLoad), 
             shape = 7, color = "red") + ## plots the geomean of measured loads
  labs(x = "Percent of Days Load Exceeded",
       y = "Load (colonies per day)") + ## x and y labels
  geom_vline(xintercept = c(.10,.4,.6,.90), linetype = 2, alpha = 0.5) + ## lines to define flow categories
  annotate("text", x = 0.05, y = max(df$load, na.rm = T) + (max(df$load, na.rm = T)), 
           label = "Highest Flows", hjust = 0.5, size = 3) +
  annotate("text", x = 0.25, y = max(df$load, na.rm = T) + (max(df$load, na.rm = T)), 
           label = "Moist Conditions", hjust = 0.5, size = 3) +
  annotate("text", x = 0.50, y = max(df$load, na.rm = T) + (max(df$load, na.rm = T)), 
           label = "Mid-Range Flow", hjust = 0.5, size = 3) +
  annotate("text", x = 0.75, y = max(df$load, na.rm = T) + (max(df$load, na.rm = T)), 
           label = "Dry Conditions", hjust = 0.5, size = 3) +
  annotate("text", x = 0.95, y = max(df$load, na.rm = T) + (max(df$load, na.rm = T)), 
           label = "Low Flows", hjust = 0.5, size = 3) +
  scale_y_log10() + ## apply log scale to y axis
  scale_x_continuous(labels = scales::percent, breaks = c(0, .1, .4, .6, .9, 1)) ## apply percent labels to x axis
```

---

```r
p
```

&lt;img src="ldc-presentation_files/figure-html/unnamed-chunk-25-1.png" style="display: block; margin: auto;" /&gt;

---
Spend some time with the labeling and theme functions in `ggplot2` to get the plot looking nice. Including legends is a challenge, and a full explanation is beyond the scope of these slides.

The script used to create the figure on the next slide. The LDC can be easily updated for any stations and date range by updating the first few lines.

https://gist.github.com/mps9506/d61a23eabe23dfe401c3da4e6e816f57

---


![](ldc-presentation_files/figure-html/unnamed-chunk-27-1.png)&lt;!-- --&gt;


---
## Refs
[1] M. Morrison and J. Bonta. _Development of Duration-Curve Based
Methods for Quantifying Variability and Change in Watershed
Hydrology and Water Quality Hydrology and Water Quality_. Tech.
rep. May. EPA, 2008.
    </textarea>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "github",
"highlightLines": true,
"countIncrementalSlides": false,
"ratio": "16:9"
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function() {
  var d = document, s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})();</script>

<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  tex2jax: {
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre']
  }
});
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
