---
title: "FDC and LDC Development in R"
author: "Michael Schramm"
output:
  xaringan::moon_reader:
    lib_dir: libs
    css: ["default", "fonts.css", "twri.css"]
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
      ratio: "16:9"
---

```{r setup, include=FALSE, cache=FALSE}
options(htmltools.dir.version = FALSE)
library(RefManageR)
BibOptions(check.entries = FALSE, 
           bib.style = "numeric",
           cite.style = "numeric",
           style = "markdown",
           hyperlink = FALSE, 
           dashed = FALSE)
Bib <- ReadBib("./ldc-presentation_files/ldc-presentation-bib.bib")
```

# Basic steps

--

- Obtain mean daily flows sorted by date for entire period of interest. If exceedances are primarily under high flow conditions, instanteous flows may provide a more accurate flow and load estimation`r AutoCite(Bib, "UnitedStatesEnvironmentalProtectionAgency2008")`.

--

- Plot exceedance probability (x-axis) against flow (y-axis) $=$ flow duration curve

--

- Convert flow to load $flow\times time\times concentration$

--

- Convert measured concentration to load and overlay on the load duration curve

---

# Flow

- Obtain flow data at relevant USGS gage

--

- Do this in R with the `dataRetrieval` package

--

```{r echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}
library(dataRetrieval)

# download data to R as a dataframe 
# this returns flow as mean daily flow in cubic feet per second
flow <- readNWISdv(siteNumbers = "08186000", 
                   parameterCd = "00060", 
                   startDate = "2001-01-01", 
                   endDate = "2016-12-31",
                   statCd = "00003")

# columns do not have informational column names
# this function will automatically rename them
flow <- renameNWISColumns(flow)
```

--

```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
head(flow)
```

---

# Calculate flow exceedance
Use `dplyr` package and some built in R functions to make a flow exceedance column

```{r message=FALSE, warning=FALSE, paged.print=FALSE}
library(dplyr)
flow <- flow %>%
  arrange(Flow) %>% # gets our flows into order by value of flow
  mutate(Exceedance = percent_rank(-Flow)) %>% # exceedance = 1 - cumulative distribution function of flow
  filter(Flow > 0)
```
--
```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
head(flow)
```

---

# Plot
Use `ggplot2` to make a flow duration curve
```{r message=FALSE, warning=FALSE, paged.print=FALSE}
library(ggplot2)
fdc <- ggplot(flow, aes(x = Exceedance, y = Flow)) +
  geom_line() +
  scale_y_log10(labels = scales::comma) +
  scale_x_continuous(labels = scales::percent) +
  labs(x = "Percent of Days Flow Exceeded",
       y = "Flow (cfs)")

```

---

#Flow Duration Curve
```{r echo=FALSE, fig.align='center', fig.dim=c(8,3), message=FALSE, warning=FALSE, dpi=200, paged.print=FALSE}
fdc
```

---
FDC in a handful of lines
```{r eval=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
library(dataRetrieval)
library(dplyr)
library(ggplot2)

flow <- readNWISdv("08186000", "00060", "2001-01-01", "2016-12-31")
flow <- renameNWISColumns(flow)

flow <- flow %>%
  arrange(Flow) %>% 
  mutate(Exceedance = percent_rank(-Flow)) %>%
  filter(Flow > 0)

ggplot(flow, aes(x = Exceedance, y = Flow)) +
  geom_line() +
  scale_y_log10(labels = scales::comma) +
  scale_x_continuous(labels = scales::percent) +
  labs(x = "Percent of Days Flow Exceeded",
       y = "Flow (cfs)")
```

---
# Convert FDC to LDC

$Daily Load=126colonies/100mL\times 28316.8mL/foot^3\times feet^3/second\times 86,400 seconds/day$

Use `dplyr` to create new column with load duration curve values calculated from mean daily flow and the 126 cfu/100 mL standard. 

```{r}
flow <- flow %>%
  mutate(ldc = 126/100 * 28316.8 * Flow * 86400)
```
--
```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
head(flow)
```

---
#Load Duration Curve
Use `ggplot2` again
```{r fig.align='center', fig.dim=c(8,3), message=FALSE, warning=FALSE, dpi=200, paged.print=FALSE}
ggplot(flow, aes(x = Exceedance, y = ldc)) +
  geom_line() +
  scale_y_log10() +
  scale_x_continuous(labels = scales::percent) +
  labs(x = "Percent of Days Load Exceeded",
       y = "Load (colonies per day)")
```


---
We also need to add measured concentrations, converted to loads.
Go back to our dataframe, we can import water quality measurements and join them by date.

We are going to use the `dataRetrieval` package to download monitoring data from STORET.

--

Alternatively, use the `readr` package and `read_csv()` or `read_xl()` functions to import concentration data. Your data should have one column for date and one column for concentration. 

--

Using `dataRetrieval`:
```{r}
ecoli <- readWQPqw(siteNumbers = c("TCEQMAIN-14211"), parameterCd = "Escherichia coli")
## When I inspect this data, it includes the holding time, I just want concentrations.
## so the next lines will filter rows that report holding time in hours
## and select only the relevant variable columns and rename them
ecoli <- ecoli %>%
  filter(ResultMeasure.MeasureUnitCode != "hours") %>%
  select(Date = ActivityStartDate, Concentration = ResultMeasureValue)
```
--
```{r echo=FALSE}
head(ecoli)
```

---
We can join the `ecoli` dataframe to the `flow` dataframe using the date and ActivityStartDate column and the `left_join()` function in `dplyr`.
```{r}
df <- flow %>%
  left_join(ecoli, by = "Date")
```
--
```{r}
head(df)
```

---
Estimate daily loads from measured concentrations
$Colonies/100mL\times Flow\times 28316.8mL/foot^3\times 86,400 seconds/day$

```{r}
df <- df %>%
  mutate(load = Concentration/100 * Flow * 28316.8 * 86400)
```
--
```{r echo=FALSE}
head(df)
```

---
# Plot the LDC

```{r fig.align='center', fig.dim=c(8,3), message=FALSE, warning=FALSE, dpi=200, paged.print=FALSE}
ggplot(df) +
  geom_line(aes(x = Exceedance, y = ldc)) +
  geom_point(aes(x = Exceedance, y = load), alpha = 0.4) +
  scale_y_log10() + scale_x_continuous(labels = scales::percent) +
  labs(x = "Percent of Days Load Exceeded",
       y = "Load (colonies per day)")
```


---

We can break our LDC into a few flow categories here. This is subjective, but it appears five categories would be appropriate. `r Citet(Bib, author = "Cleland2003")` provides some guidance.

```{r, fig.align='center', fig.dim=c(8,3), message=FALSE, warning=FALSE, dpi=200, paged.print=FALSE}
ggplot(df) +
  geom_line(aes(x = Exceedance, y = ldc)) +
  geom_point(aes(x = Exceedance, y = load), alpha = 0.4) +
  scale_y_log10() + scale_x_continuous(labels = scales::percent) +
  labs(x = "Percent of Days Load Exceeded",
       y = "Load (colonies per day)") +
  geom_vline(xintercept = c(.10,.4,.6,.90), linetype = 2) #<<
```

---

There are a few approaches for estimating loads. For example, we could use the USGS `LOADEST` tool estimate loads with regressions. For simplicilty, I will estimate the geometric mean load in each flow category from measured values and subtract that from the geometric mean allowable load. This is used in the Tres Palacios, Carancahua Bay, and Aransas/Poesta Creek TMDLs.

---

The general approach:

--

- Group estimated loads and allowable loads by flow category

--

- Calculate the geomean for each flow category

--

- Take the difference to estimate mean daily reductions for each category

---
We need to load another package to get a function that calculates the geometric mean.
```{r message=FALSE, warning=FALSE, paged.print=FALSE}
## Comment out the line below to install the package if you don't have it
## install.packages("DescTools")
library(DescTools)
```

---
Now create a column for the flow groups. We decided on 0-10%, 10-40%, 40-60%, 60-90%, and 90-100% earlier.
```{r}
# creates a column specifying the flow category based on exceedance value
df <- df %>%
  mutate(fc = case_when(
    Exceedance <= .10 ~ "Highest Flows",
    Exceedance > .10 & Exceedance <= .40 ~ "Moist Conditions",
    Exceedance > .40 & Exceedance <= .60 ~ "Mid-range Conditions",
    Exceedance > .60 & Exceedance <= .90 ~ "Dry Conditions",
    Exceedance > .90 & Exceedance <= 1 ~ "Low Flows"
  ))
```

---
Now we can use dplyr to group the observations by flow category (the new fc column) and calculate the geometric mean in each category
```{r}
df_summary <- df %>%
  group_by(fc) %>%
  summarise(AllowableLoad = Gmean(ldc, na.rm = TRUE),  ## Gmean function is from DescTools
            GMConc = Gmean(Concentration, na.rm = TRUE),
            MeasuredLoad = Gmean(load, na.rm = TRUE),
            Exceedance = round(median(Exceedance),digits = 2)) ## Exceedance is the x-axis coordinate
```


--

```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
df_summary
```

---
#Basic LDC
```{r, fig.align='center', fig.dim=c(8,3), dpi=200, message=FALSE, warning=FALSE, paged.print=FALSE}
ggplot(df) +
  geom_line(aes(x = Exceedance, y = ldc)) +
  geom_point(aes(x = Exceedance, y = load), alpha = 0.4) +
  geom_point(data = df_summary, aes(x = Exceedance, y = MeasuredLoad), shape = 7, color = "red") +
  scale_y_log10() + scale_x_continuous(labels = scales::percent) +
  labs(x = "Percent of Days Load Exceeded",
       y = "Load (colonies per day)") +
  geom_vline(xintercept = c(.10,.4,.6,.90), linetype = 2)
```

---
We probably want to fancy this plot up.

```{r, fig.align='center', fig.dim=c(8,3), dpi=200, message=FALSE, warning=FALSE, paged.print=FALSE}
p <- ggplot(df) +
  geom_line(aes(x = Exceedance, y = ldc)) + ## plots the allowable load
  geom_point(aes(x = Exceedance, y = load), 
             alpha = 0.4) + ## plots the measured loads
  geom_point(data = df_summary, aes(x = Exceedance, y = MeasuredLoad), 
             shape = 7, color = "red") + ## plots the geomean of measured loads
  labs(x = "Percent of Days Load Exceeded",
       y = "Load (colonies per day)") + ## x and y labels
  geom_vline(xintercept = c(.10,.4,.6,.90), linetype = 2, alpha = 0.5) + ## lines to define flow categories
  annotate("text", x = 0.05, y = max(df$load, na.rm = T) + (max(df$load, na.rm = T)), 
           label = "Highest Flows", hjust = 0.5, size = 3) +
  annotate("text", x = 0.25, y = max(df$load, na.rm = T) + (max(df$load, na.rm = T)), 
           label = "Moist Conditions", hjust = 0.5, size = 3) +
  annotate("text", x = 0.50, y = max(df$load, na.rm = T) + (max(df$load, na.rm = T)), 
           label = "Mid-Range Flow", hjust = 0.5, size = 3) +
  annotate("text", x = 0.75, y = max(df$load, na.rm = T) + (max(df$load, na.rm = T)), 
           label = "Dry Conditions", hjust = 0.5, size = 3) +
  annotate("text", x = 0.95, y = max(df$load, na.rm = T) + (max(df$load, na.rm = T)), 
           label = "Low Flows", hjust = 0.5, size = 3) +
  scale_y_log10() + ## apply log scale to y axis
  scale_x_continuous(labels = scales::percent, breaks = c(0, .1, .4, .6, .9, 1)) ## apply percent labels to x axis
```

---
```{r, fig.align='center', fig.dim=c(8,3), dpi=200, message=FALSE, warning=FALSE, paged.print=FALSE}

p

```

---
Spend some time with the labeling and theme functions in `ggplot2` to get the plot looking nice. Including legends is a challenge, and a full explanation is beyond the scope of these slides.

The script used to create the figure on the next slide. The LDC can be easily updated for any stations and date range by updating the first few lines.

https://gist.github.com/mps9506/d61a23eabe23dfe401c3da4e6e816f57

---
```{r, echo=FALSE, fig.align='center', fig.dim=c(8,3), message=FALSE, warning=FALSE, dpi=200, paged.print=FALSE}

library(hrbrthemes)
library(purrr)

df_summary2 <- df %>%
  group_by(fc) %>%
  do(AllowableLoad = Gmean(.$ldc, na.rm = TRUE),
     GMConc = Gmean(.$Concentration, na.rm = TRUE),
     Exceedance = round(median(.$Exceedance), digits = 2),
     GMLoad = Gmean(.$load, conf.level = 0.95, na.rm = TRUE)) %>%
  tidyr::unnest(AllowableLoad, GMConc, Exceedance) %>%
  mutate(GMmeanLoad = map_dbl(.$GMLoad,c("mean")),
         GMmeanLow = map_dbl(.$GMLoad,c("lwr.ci")),
         GMmeanHigh = map_dbl(.$GMLoad,c("upr.ci")))
  #mutate(AllowableLoad2 = map_dbl(.$AllowableLoad)) %>%
  #NULL
  

```

```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, fig.dim=c(8,5.5), dpi=200}
ggplot(df) +
  geom_line(aes(x = Exceedance, y = ldc, linetype = "Allowable Load at Geomean Criterion")) +
  geom_point(aes(x = Exceedance, y = load, 
                 shape = "Sampling Events", 
                 fill = "Sampling Events",
                 alpha = "Sampling Events")) + 
  geom_pointrange(data = df_summary2, aes(x = Exceedance, 
                                          y = GMmeanLoad, 
                                          ymin = GMmeanLow, 
                                          ymax = GMmeanHigh,
                                          color = "Geomean Load with 95% CI"), 
                  shape = 22, fill = "white") +
  labs(title = expression(paste(bolditalic("E. coli"),bold(" Load Duration Curve"))),
       subtitle = "TCEQ Station 14211, USGS Gage 08186000, 2001 - 2017",
       x = "Percent of Days Load Exceeded",
       y = "Load (colonies per day)") +
  geom_vline(xintercept = c(.10,.4,.6,.90), linetype = 2, alpha = 0.5) +
  annotate("text", x = 0.05, y = max(df$load, na.rm = T) + (max(df$load, na.rm = T)), 
           label = "High Flows", hjust = 0.5, size = 3) +
  annotate("text", x = 0.25, y = max(df$load, na.rm = T) + (max(df$load, na.rm = T)), 
           label = "Moist Conditions", hjust = 0.5, size = 3) +
  annotate("text", x = 0.50, y = max(df$load, na.rm = T) + (max(df$load, na.rm = T)), 
           label = "Mid-Range Flow", hjust = 0.5, size = 3) +
  annotate("text", x = 0.75, y = max(df$load, na.rm = T) + (max(df$load, na.rm = T)), 
           label = "Dry Conditions", hjust = 0.5, size = 3) +
  annotate("text", x = 0.95, y = max(df$load, na.rm = T) + (max(df$load, na.rm = T)), 
           label = "Low Flows", hjust = 0.5, size = 3) +
  scale_y_log10() +
  scale_x_continuous(labels = scales::percent, breaks = c(0, .1, .4, .6, .9, 1)) +
  scale_color_manual(name = NULL, breaks = c("Geomean Load with 95% CI"), values = c("#e41a1c"),
                     guide = guide_legend(title = NULL, title.position = "right")) +
  scale_fill_manual(name = NULL, breaks = c("Sampling Events"), values = c("#377eb8"),
                     guide = guide_legend(title = NULL, title.position = "right")) +
  scale_alpha_manual(name = NULL, breaks = c("Sampling Events"), values = c(0.5),
                     guide = guide_legend(title = NULL, title.position = "right")) +
  scale_shape_manual(name = NULL, 
                     breaks = c("Sampling Events"), 
                     values = c(21),
                     guide = guide_legend(title = NULL, title.position = "right")) +
  scale_linetype_manual(name = NULL, 
                     breaks = c("Allowable Load at Geomean Criterion"), 
                     values = c(1),
                     guide = guide_legend(title = NULL, title.position = "right")) +
  theme_ipsum_rc(axis = TRUE, plot_title_size = 14, subtitle_size = 11) +
  theme(legend.title = element_blank(),
        legend.position = "bottom",
        legend.direction = "vertical",
        legend.box = "horizontal", 
        legend.key = element_blank(),
        legend.spacing.y = unit(0, 'lines'),
        panel.background = element_blank())
```


---
## Refs
```{r, 'refs', results='asis', echo = FALSE}
PrintBibliography(bib = Bib)
```

